<!-- Global site tag (gtag.js) - Google Analytics -->
<script defer src="https://www.googletagmanager.com/gtag/js?id={{ site.analytics.google.id }}"></script>
<!-- Add cookie consent css & js -->
<link rel="stylesheet"
    type="text/css"
    href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/>
<script defer src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"
    data-cfasync="false"></script>
<!-- Consent note credit to https://gist.github.com/Chuvisco88/2b446a5c9190b77b41eaafab358223ec -->
<script defer>
  console.log("CUSTOM ANALYTICS" + document.readyState);
    function getCookie(name) {
        var b = document.cookie.match('(^|[^;]+)\\s*' + name + '\\s*=\\s*([^;]+)');
        return b ? b.pop() : '';
    }
  function addAnalytics() {
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    };

    gtag('js', new Date());
    gtag('config', '{{ site.analytics.google.id }}');
  };
  
  if (document.readyState !== 'loading') {
    console.log("Was ready");
    runCookieCheck();
  } else {
     window.addEventListener("DOMContentLoaded", function () {
       runCookieCheck();
     });
  }
  
  function runCookieCheck() {
        const cookieConsent = getCookie('cookieconsent_status');
        console.log("Cookie Consent: " + cookieConsent);

        if (cookieConsent === 'allow') {
            console.log("Adding analytics");
            addAnalytics();
        }
    
        window.cookieconsent.initialise({
            "palette": {
                "popup": {
                    "background": "#efefef",
                    "text": "#404040"
                },
                "button": {
                    "background": "#8ec760",
                    "text": "#ffffff"
                }
            },
            "type": "opt-in",
            "content": {
                "allow": "Approve",
                "dismiss": "Approve",
                "deny": "Reject"
            },
            onStatusChange: function (status, chosenBefore) {
                location.reload();
            }
        })
    };

  console.log("Custom analytics script!");
</script>
